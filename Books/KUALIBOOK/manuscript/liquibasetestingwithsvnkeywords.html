<h2>Liquibase Testing with SVN Keywords</h2>
<h3>Abstract</h3>In <a href="http://kualigan.blogspot.com/2010/04/kis-of-dragon-testing-liquibase_27.html">KIS of the Dragon</a>, I documented using the <a href="http://www.liquibase.org">liquibase</a> rollback functionality for testing. Since then, I have found that <a href="http://www.liquibase.org">liquibase</a> has a small bug with rollbacks. Some of you may have encountered it. It uses regex substitution when rolling back (not sure what exactly). Part of defining the group in regex substitution is the '$', so that makes '$' kind of a reserved character that isn't very well documented in liquibase. It doesn't effect SQL at all, but it does mean using '$' in changeSet attributes is forbidden. Just to give an example of what will happen, when you rollback in this scenario, you get an exception:<br /><p>Jun 5, 2010 8:07:24 AM liquibase.commandline.Main main<br />SEVERE: Illegal group reference<br />java.lang.IllegalArgumentException: Illegal group reference<br /> at java.util.regex.Matcher.appendReplacement(Matcher.java:725)<br /> at java.util.regex.Matcher.replaceFirst(Matcher.java:872)<br /> at java.lang.String.replaceFirst(String.java:2158)<br /> at liquibase.database.AbstractDatabase.removeRanStatus(AbstractDatabase.java:1328)<br /> at liquibase.parser.visitor.RollbackVisitor.visit(RollbackVisitor.java:23)<br /> at liquibase.parser.ChangeLogIterator.run(ChangeLogIterator.java:41)<br /> at liquibase.Liquibase.rollback(Liquibase.java:273)<br /> at liquibase.Liquibase.rollback(Liquibase.java:248)<br /> at liquibase.commandline.Main.doMigration(Main.java:682)<br /> at liquibase.commandline.Main.main(Main.java:97)</p><br />Below, we have the offending XML responsible for this.<br /><pre>&lt;databaseChangeLog<br />  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"<br />  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9<br />         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd&quot;&amp;gh;<p>  &lt;changeSet id=&quot;$Revision$&quot; author=&quot;$Author$&quot;&gt;</p></pre><br /><h3>Problem</h3>You probably thought the above was the problem. No no no no no. That was just background on it. Such a thing is actually easily fixed. The real problem is testing in your IDE. The reason we have '$' is for the <a href="http://subversion.tigris.org">Subversion</a> keywords. We want these in our changelogs so we can rollback in our other environments. <a href="http://subversion.tigris.org">Subversion</a> doesn't actually add this information until after the <i>svn:keywords</i> property and the file are committed to the VCS. When it does, you get something that looks like this:<br /><pre>&lt;databaseChangeLog<br />  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"<br />  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9<br />         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd&quot;&amp;gh;<p>  &lt;changeSet id=&quot;$Revision: 1$&quot; author=&quot;$Author: przybyls$&quot;&gt;</p></pre><br />There are still '$' in there.<p><h4>What does this have to do with the IDE?</h4>At UA, we use a <a href="http://www.liquibase.org">liquibase</a> template, so all developers are consistent with their usage. It looks something like:<br /><pre><br />&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</pre></p><p>&lt;databaseChangeLog<br />  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"<br />  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9<br />         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd&quot;&gt;</p><p>  &lt;changeSet id=&quot;$Revision$&quot; author=&quot;$Author$&quot;&gt;<br />    &lt;sql splitStatements=&quot;false&quot; endDelimiter=&quot;&quot;&gt;&lt;![CDATA[<br />    DECLARE<br />    BEGIN<br />    END;<br />]]&gt;<br />    &lt;/sql&gt;<br />    &lt;rollback&gt;<br />      &lt;sql&gt;&lt;![CDATA[<br />      DECLARE<br />      BEGIN<br />      END;<br />]]&gt;<br />      &lt;/sql&gt;<br />    &lt;/rollback&gt;<br />  &lt;/changeSet&gt;<br />&lt;/databaseChangeLog&gt;<br />The first thing you should notice is the '$' in the id and author attributes. This actually makes the problem part of our IDE. Now developers have to remember to change this. That makes this template pretty much...useless.</p><p><h3>Solution (it's not as cool as you think)</h3>At UA, we decided to take <a href="http://www.liquibase.org">liquibase</a> testing out of our IDE and instead move it into continuous integration with Ad-Hoc builds. In the end, developers still use the template. Only now, they don't need to install <a href="http://www.liquibase.org">liquibase</a> at all! It's one of those, "Why didn't I think of this before!?" moments.</p><p><h3>Instructions for <a href="http://www.hudson-ci.org">Hudson</a></h3>I hope you're using <a href="http://www.hudson-ci.org">Hudson</a>. If you're not, you have my sympathies. I am truly sorry that you will have to find your own way of doing this.</p><p><h4>Step 1: Create an ad-hoc build</h4>To do this, you simply setup a build parameter in your project/build configuration. When you do this, <a href="http://www.hudson-ci.org">Hudson</a> will want to know about the parameter you are adding. I used a file. This way developers simply upload their file to <a href="http://www.hudson-ci.org">Hudson</a>. I called mine <i>test.xml</i> and you will see that come up in a second.</p><p><h4>Step 2: Setup the Execution Script</h4>I just used shell with the following contents:<br /><p><br />/home/tomcat/liquibase/liquibase --defaultsFile=/home/tomcat/renwoluk.properties tag before<br />sed -e &#39;s/\$Revision\$/test/g&#39; test.xml &gt; /tmp/test.xml;mv /tmp/test.xml test.xml<br />sed -e &#39;s/\$Author\$/test/g&#39; test.xml &gt; /tmp/test.xml;mv /tmp/test.xml test.xml<br />/home/tomcat/liquibase/liquibase --defaultsFile=/home/tomcat/renwoluk.properties --changeLogFile=test.xml updateSQL<br />/home/tomcat/liquibase/liquibase --defaultsFile=/home/tomcat/renwoluk.properties --changeLogFile=test.xml update<br />/home/tomcat/liquibase/liquibase --defaultsFile=/home/tomcat/renwoluk.properties --changeLogFile=test.xml rollbackSQL before<br />/home/tomcat/liquibase/liquibase --defaultsFile=/home/tomcat/renwoluk.properties --changeLogFile=test.xml rollback before</p><br />Notice the sed commands that do the replace on test.xml. It is then simply doing an update and rollback just like in <a href="http://kualigan.blogspot.com/2010/04/kis-of-dragon-testing-liquibase_27.html">KIS of the Dragon</a>.</p><p><h3>Conclusion</h3>That's it. Now developers can all test their <a href="http://www.liquibase.org">liquibase</a> changelogs in a consistent manner without any modification to their IDE. <a href="http://www.hudson-ci.org">Hudson</a> is also really effective here because changelog testing is really really fast. It takes a few seconds and won't hang up <a href="http://www.hudson-ci.org">Hudson</a>. <a href="http://www.hudson-ci.org">Hudson</a> also can facilitate multiple executors. I will include in another post on <a href="http://www.liquibase.org">liquibase</a> automation how to integrate this into configuration management and automated build processes.</p><p><h3>Apologies</h3>I am very sorry for the content in <a href="http://kualigan.blogspot.com/2010/04/kis-of-dragon-testing-liquibase_27.html">KIS of the Dragon</a> because it was somewhat incorrect. I'm glad to remedy it here.</p><p>I also apologize for having not put out a screencast in awhile. My goal was one a week. I've had some family crisis to deal with lately and I made the mistake of working on a few at the same time. In the coming week, expect a torrent of posts.<div></div></p>